#!/usr/bin/env bash

# Pre-commit hook: scan content/concepts/ for sensitive personal information.
# Catches emails, phone numbers, SSNs, and common secret patterns.

CONCEPTS_DIR="content/concepts"

if [ ! -d "$CONCEPTS_DIR" ]; then
  exit 0
fi

PATTERNS=(
  # Email addresses
  '[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}'
  # US phone numbers (various formats)
  '\b(\+?1[-.\s]?)?(\(?\d{3}\)?[-.\s]?)?\d{3}[-.\s]?\d{4}\b'
  # SSN
  '\b\d{3}-\d{2}-\d{4}\b'
  # API keys / tokens (generic long hex or base64 strings labeled as keys)
  '(?i)(api[_-]?key|secret|token|password)\s*[:=]\s*\S+'
  # IP addresses (v4)
  '\b\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}\b'
  # Credit card numbers (basic 16 digit patterns)
  '\b\d{4}[-\s]?\d{4}[-\s]?\d{4}[-\s]?\d{4}\b'
)

FOUND=0

for pattern in "${PATTERNS[@]}"; do
  MATCHES=$(rg --no-filename --line-number -P "$pattern" "$CONCEPTS_DIR" 2>/dev/null)
  if [ -n "$MATCHES" ]; then
    if [ "$FOUND" -eq 0 ]; then
      echo ""
      echo "⚠ Pre-commit check: potential sensitive info found in $CONCEPTS_DIR"
      echo "─────────────────────────────────────────────────────────────────"
    fi
    FOUND=1
    echo ""
    echo "Pattern: $pattern"
    echo "$MATCHES" | head -10
  fi
done

if [ "$FOUND" -eq 1 ]; then
  echo ""
  echo "─────────────────────────────────────────────────────────────────"
  echo "Review the matches above. To commit anyway: git commit --no-verify"
  echo ""
  exit 1
fi

exit 0
